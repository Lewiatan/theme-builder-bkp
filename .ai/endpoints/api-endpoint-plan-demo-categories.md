# REST API Endpoint Implementation Plan: GET /api/demo/categories

## 1. Requirements Analysis

### Objective
Create a public API endpoint that returns all product categories for the Demo Shop. This endpoint supports the CategoryPills component and category filtering functionality on the Catalog page.

### Key Requirements
- **Authentication**: None required (public endpoint)
- **Response Format**: JSON with categories array containing id and name
- **Ordering**: Alphabetically by name (ascending)
- **Pagination**: Not needed (small, static dataset of 6 categories)
- **Performance**: Single query with minimal overhead
- **Use Cases**:
  - CategoryPills component fetches categories for navigation
  - Category filtering provides list for filtering products

### Route Specification
```
GET /api/demo/categories
```

**Response (200 OK):**
```json
{
  "categories": [
    {"id": 1, "name": "Beauty & Personal Care"},
    {"id": 2, "name": "Books"},
    {"id": 3, "name": "Clothing"},
    {"id": 4, "name": "Electronics"},
    {"id": 5, "name": "Home & Garden"},
    {"id": 6, "name": "Sports & Outdoors"}
  ]
}
```

---

## 2. Architectural Overview

### Design Pattern
This endpoint follows the **Repository Pattern** with **Read Models** to maintain separation of concerns:

1. **Controller Layer**: Handles HTTP request/response and error handling
2. **Service Layer**: Orchestrates business logic (minimal for this simple read operation)
3. **Repository Layer**: Executes database queries and maps to Read Models
4. **Read Model Layer**: Decouples database structure from API responses

### Technology Stack
- **Framework**: Symfony 7.3
- **Database**: PostgreSQL 16 with Doctrine DBAL
- **Response**: Symfony JsonResponse with automatic serialization
- **Logging**: Symfony's PSR-3 LoggerInterface
- **Testing**: PHPUnit for unit tests, functional tests for integration

### Architecture Principles Applied
- **Clean Architecture**: Clear separation between layers with dependencies pointing inward
- **Single Responsibility**: Each class has one clear purpose
- **ReadModel Pattern**: API responses decouple from database structure

---

## 3. Technical Specification

### 3.1. Database Schema

**Existing Table**: `demo_categories`

```sql
create table demo_categories (
    id integer primary key generated by default as identity,
    name varchar(255) not null
);
```

**Seed Data** (from `DemoProductsSeeder.php`):
```php
['id' => 1, 'name' => 'Electronics'],
['id' => 2, 'name' => 'Clothing'],
['id' => 3, 'name' => 'Books'],
['id' => 4, 'name' => 'Home & Garden'],
['id' => 5, 'name' => 'Sports & Outdoors'],
['id' => 6, 'name' => 'Beauty & Personal Care'],
```

**No schema changes required** - the table already exists.

### 3.2. Read Model

**Location**: `/home/maciej/web/theme-builder/backend/src/ReadModel/DemoCategoryReadModel.php`

**Purpose**: Represents a category for API responses, decoupling database structure from API contract.

**Design Decisions**:
- `final readonly class`: Immutable by design, prevents inheritance
- `JsonSerializable`: Enables automatic JSON encoding by Symfony
- Simple structure: Only id and name fields (no timestamps, no relations)
- No getters needed: Only used for JSON serialization

### 3.3. Repository Layer

**Location**: `/home/maciej/web/theme-builder/backend/src/Repository/DemoCategoryRepository.php`

**Purpose**: Handles database queries for categories and maps results to Read Models.

**Design Decisions**:
- Raw SQL with Doctrine DBAL: Optimal performance for simple queries
- `ORDER BY name ASC`: Ensures consistent alphabetical ordering
- Type casting `(int)`: Ensures strict type compliance
- No pagination: Small, static dataset (6 categories)
- Private mapper method: Encapsulates row-to-model conversion logic

### 3.4. Service Layer

**Location**: `/home/maciej/web/theme-builder/backend/src/Service/DemoCategoryService.php`

**Purpose**: Orchestrates business logic for category retrieval (minimal for this endpoint).

**Design Decisions**:
- Thin service layer: Direct pass-through for this simple operation
- Future-proofing: Allows adding caching, logging, or transformation logic
- Consistent pattern: Matches existing `DemoProductService` architecture
- Constructor injection: Leverages Symfony's dependency injection

### 3.5. Controller Layer

**Location**: Update existing `/home/maciej/web/theme-builder/backend/src/Controller/PublicShopController.php`

**Purpose**: Handles HTTP request/response for the categories endpoint.

**Controller Updates Required**:
1. Add `DemoCategoryService` to constructor injection
2. Add new route method `getDemoCategories()`

**Design Decisions**:
- Reuse existing controller: Keeps demo endpoints together
- Generic error handling: Catches all throwables and logs details
- Consistent response format: Matches existing endpoint patterns
- PSR-3 logging: Captures errors for debugging without exposing internals
- No validation needed: No query parameters or request body

### 3.6. API Response Format

**Success Response (200 OK)**:
```json
{
  "categories": [
    {"id": 1, "name": "Beauty & Personal Care"},
    {"id": 2, "name": "Books"},
    {"id": 3, "name": "Clothing"},
    {"id": 4, "name": "Electronics"},
    {"id": 5, "name": "Home & Garden"},
    {"id": 6, "name": "Sports & Outdoors"}
  ]
}
```

**Error Response (500 Internal Server Error)**:
```json
{
  "error": "An unexpected error occurred"
}
```

**Response Structure**:
- Top-level `categories` array wraps the category list
- Each category object contains `id` (integer) and `name` (string)
- Alphabetically sorted by name (ascending)
- HTTP status codes: 200 (success), 500 (server error)

---

## 4. Implementation Phases

### Phase 1: Create Read Model
**Priority**: High
**Estimated Time**: 5 minutes

**Tasks**:
1. Create `/home/maciej/web/theme-builder/backend/src/ReadModel/DemoCategoryReadModel.php`
2. Implement `final readonly class` with `JsonSerializable`
3. Add constructor with `id` and `name` properties
4. Implement `jsonSerialize()` method

**Acceptance Criteria**:
- Class is final and readonly
- Implements JsonSerializable interface
- PHPDoc includes complete type information
- No getters needed (properties are public readonly)

### Phase 2: Create Repository
**Priority**: High
**Estimated Time**: 10 minutes

**Tasks**:
1. Create `/home/maciej/web/theme-builder/backend/src/Repository/DemoCategoryRepository.php`
2. Inject `ManagerRegistry` and get DBAL connection
3. Implement `findAllCategories()` method with SQL query
4. Implement private `mapRowToReadModel()` method
5. Add comprehensive PHPDoc for all methods

**Acceptance Criteria**:
- Uses raw SQL with Doctrine DBAL Connection
- Returns array of `DemoCategoryReadModel` instances
- Orders results by name ascending
- Type-casts database values appropriately
- No pagination (returns all categories)

### Phase 3: Create Service
**Priority**: High
**Estimated Time**: 5 minutes

**Tasks**:
1. Create `/home/maciej/web/theme-builder/backend/src/Service/DemoCategoryService.php`
2. Inject `DemoCategoryRepository` via constructor
3. Implement `getAllCategories()` method
4. Add PHPDoc explaining service purpose

**Acceptance Criteria**:
- Constructor injection of repository
- Simple pass-through method to repository
- Consistent with existing service architecture
- Allows future enhancement without API changes

### Phase 4: Update Controller
**Priority**: High
**Estimated Time**: 10 minutes

**Tasks**:
1. Update `/home/maciej/web/theme-builder/backend/src/Controller/PublicShopController.php`
2. Add `DemoCategoryService` to constructor injection
3. Add `getDemoCategories()` method with `#[Route]` attribute
4. Implement try-catch error handling
5. Return JsonResponse with categories array

**Acceptance Criteria**:
- Route: `/api/demo/categories`, name: `demo_categories_list`, method: GET
- Returns 200 OK with categories array on success
- Returns 500 Internal Server Error on exception
- Logs errors with context for debugging
- Matches existing controller method patterns

### Phase 5: Service Configuration
**Priority**: High
**Estimated Time**: 2 minutes

**Tasks**:
1. Verify Symfony's autowiring detects new services
2. If needed, explicitly configure services in `config/services.yaml`

**Note**: With Symfony's default autowiring, explicit configuration should not be needed.

**Acceptance Criteria**:
- Services are automatically registered by Symfony
- Dependency injection works without manual configuration

### Phase 6: Manual Testing
**Priority**: High
**Estimated Time**: 10 minutes

**Tasks**:
1. Start Docker environment: `docker compose up`
2. Clear Symfony cache: `docker compose exec backend php bin/console cache:clear`
3. Test endpoint: `curl http://localhost:8000/api/demo/categories`
4. Verify response format and alphabetical ordering
5. Verify categories match seed data

**Acceptance Criteria**:
- Endpoint returns 200 OK status
- Response includes 6 categories
- Categories are ordered alphabetically by name
- Response structure matches specification

### Phase 7: Write Unit Tests
**Priority**: High
**Estimated Time**: 30 minutes

**Tasks**:
1. Create `/home/maciej/web/theme-builder/backend/tests/Unit/Repository/DemoCategoryRepositoryTest.php`
2. Create `/home/maciej/web/theme-builder/backend/tests/Unit/Service/DemoCategoryServiceTest.php`
3. Test repository mapping and query logic
4. Test service orchestration
5. Run tests: `docker compose exec backend vendor/bin/phpunit`

**Acceptance Criteria**:
- Repository test verifies row-to-model mapping
- Service test verifies repository delegation
- All tests pass with 100% code coverage for new classes
- Tests follow PHPUnit best practices (Arrange-Act-Assert)

---

## 5. Testing Strategy

### 5.1. Unit Tests

#### DemoCategoryRepositoryTest
**Location**: `/home/maciej/web/theme-builder/backend/tests/Unit/Repository/DemoCategoryRepositoryTest.php`

**Test Cases**:
1. `it_returns_all_categories_ordered_by_name()`: Verify query returns all categories in alphabetical order
2. `it_maps_database_rows_to_read_models_correctly()`: Verify type casting and model creation
3. `it_returns_empty_array_when_no_categories_exist()`: Test edge case with empty table

**Mocking Strategy**:
- Mock `ManagerRegistry` and `Connection`
- Use `expects()` with `fetchAllAssociative()` to control query results
- Verify SQL query structure and ORDER BY clause

#### DemoCategoryServiceTest
**Location**: `/home/maciej/web/theme-builder/backend/tests/Unit/Service/DemoCategoryServiceTest.php`

**Test Cases**:
1. `it_returns_categories_from_repository()`: Verify service delegates to repository
2. `it_returns_empty_array_when_no_categories()`: Test empty result handling

**Mocking Strategy**:
- Mock `DemoCategoryRepository`
- Use `expects()` to verify `findAllCategories()` is called once
- Assert returned value matches repository mock

---

## 9. Dependencies

### 9.1. Existing Dependencies
**No new dependencies required** - All necessary packages already installed:
- Symfony 7.3 framework
- Doctrine DBAL for database access
- PSR-3 Logger interface

### 9.2. Database Dependencies
**Prerequisite**: `demo_categories` table must exist and be seeded

**Verification**:
```bash
docker compose exec backend php bin/console doctrine:query:sql "SELECT COUNT(*) FROM demo_categories"
```

**Expected Output**: 6 categories

---

## 10. Deployment Checklist

### Pre-Deployment
- [ ] All unit tests pass
- [ ] Manual testing completed successfully
- [ ] Code review completed
- [ ] No breaking changes to existing endpoints

### Post-Deployment Verification
- [ ] GET /api/demo/categories returns 200 OK
- [ ] Response structure matches specification
- [ ] Categories are sorted alphabetically
- [ ] Frontend CategoryPills component loads categories
- [ ] Category filtering works with products endpoint

### Rollback Plan
If deployment fails:
1. Revert backend deployment to previous version
2. No database rollback needed (read-only endpoint, no schema changes)
3. Verify previous version still functional

---

## 11. Implementation Summary

### Files to Create
1. `/home/maciej/web/theme-builder/backend/src/ReadModel/DemoCategoryReadModel.php` - Read model for API response
2. `/home/maciej/web/theme-builder/backend/src/Repository/DemoCategoryRepository.php` - Database repository
3. `/home/maciej/web/theme-builder/backend/src/Service/DemoCategoryService.php` - Business logic service
4. `/home/maciej/web/theme-builder/backend/tests/Unit/Repository/DemoCategoryRepositoryTest.php` - Repository unit tests
5. `/home/maciej/web/theme-builder/backend/tests/Unit/Service/DemoCategoryServiceTest.php` - Service unit tests

### Files to Update
1. `/home/maciej/web/theme-builder/backend/src/Controller/PublicShopController.php` - Add getDemoCategories() method and inject DemoCategoryService
2. `/home/maciej/web/theme-builder/backend/tests/Functional/Controller/PublicShopControllerTest.php` - Add functional tests
3. `/home/maciej/web/theme-builder/.ai/api-plan.md` - Add endpoint documentation
4. `/home/maciej/web/theme-builder/CHANGELOG.md` - Add changelog entry

### Success Criteria
- ✅ Endpoint returns 200 OK with 6 categories
- ✅ Categories ordered alphabetically by name
- ✅ Response structure matches specification
- ✅ All unit tests pass (>80% coverage)
- ✅ No performance degradation (<50ms response time)

---
